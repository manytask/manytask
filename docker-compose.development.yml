networks:
  manytask-dev:
    driver: bridge

services:

    docs:
        build:
            context: .
            target: docs
        container_name: test-manytask-docs
        restart: always
        networks:
            - manytask-dev
        expose:
            - "80"
        environment:
            VIRTUAL_HOST: ${DOCS_HOST}
            VIRTUAL_PORT: 80
            LETSENCRYPT_HOST: ${DOCS_HOST}
        healthcheck:
            test: [ "CMD", "curl", "-f", "http://localhost:80" ]
            interval: 1m
            timeout: 15s
            retries: 3
            start_period: 30s

    manytask:
        build:
            context: .
            target: app
        container_name: test-manytask
        env_file: .env
        environment:
            VIRTUAL_HOST: ${APP_HOST}
            VIRTUAL_PORT: 5050
            LETSENCRYPT_HOST: ${APP_HOST}
        ports:
            - "8081:5050"
        volumes:
            - ./manytask/:/app/manytask
            - .tmp/cache/:/cache
        dns:
            - 8.8.8.8
            - 8.8.4.4
        depends_on:
            postgres:
                condition: service_healthy
        networks:
            - manytask-dev

    postgres:
        image: postgres:17
        container_name: manytask_postgres
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: postgres
            PGPORT: 6433
        ports:
            - "6433:6433"
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./init-db.sh:/docker-entrypoint-initdb.d/init-db.sh
        networks:
            - manytask-dev
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres -d postgres -p 6433"]
            interval: 5s
            timeout: 5s
            retries: 5


volumes:
    postgres_data:
        name: manytask_postgres_data
