{% extends "layout.html" %}
{% set active_page = "database" -%}

{% block content %}
    <div class="container-fluid">
        <h2>Course Database</h2>
        <div id="database-table" style="max-width: 800px; width: 100%; overflow-x: auto;"></div>

        {% if is_course_admin %}
        <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">Edit Score</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editForm">
                            <div class="mb-3">
                                <label class="form-label">Score</label>
                                <input type="number" class="form-control" id="scoreInput">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="saveChanges()">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@5/dist/js/tabulator.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tabulator-tables@5/dist/css/tabulator.min.css" rel="stylesheet"
          id="light-theme">
    <link href="https://cdn.jsdelivr.net/npm/tabulator-tables@5/dist/css/tabulator_midnight.min.css" rel="stylesheet"
          id="dark-theme" disabled>

    <style>
        [data-bs-theme="dark"] .tabulator-footer .tabulator-paginator .tabulator-page:not(.active) {
            color: #666666 !important;
            background-color: #333333 !important;
            opacity: 1 !important;
        }

        /* Export button styles */
        #export-csv {
            border: 1px solid #aaaaaa;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #ffffff33;
            color: #212529;
        }

        [data-bs-theme="dark"] #export-csv {
            background-color: #5c5c5c;
            color: #ffffff;
            border-color: #6c757d;
        }

        [data-bs-theme="dark"] #export-csv:hover {
            background-color: #202020;
            border-color: #adb5bd;
        }

        #export-csv:hover {
            background-color: #9e9e9e;
            border-color: #ced4da;
        }

        .tabulator {
            width: 100% !important;
            max-width: 100% !important;
        }

        .tabulator-cell {
            white-space: normal !important;
            word-break: break-word !important;
            overflow: visible !important;
            text-overflow: clip !important;
        }

        .tabulator .tabulator-header .tabulator-col-content {
            white-space: normal !important;
            word-break: break-word !important;
        }
    </style>

    <script>
        let currentEditCell = null;
        let editModal = null;

        function editCell(cell) {
            const readonlyFields = {{ readonly_fields|tojson }};
            if (readonlyFields.includes(cell.getField())) {
                return;
            }

            const isAdmin = {{ is_course_admin|tojson }};
            if (!isAdmin) {
                return;
            }

            currentEditCell = cell;
            const value = cell.getValue() || 0;
            const scoreInput = document.getElementById('scoreInput');
            scoreInput.value = value;
            document.getElementById('editModalLabel').textContent = `Edit Score for ${cell.getColumn().getDefinition().title}`;
            editModal.show();

            // Immediately select input field after modal is shown
            editModal._element.addEventListener('shown.bs.modal', function () {
                scoreInput.select();
            }, { once: true });
        }

        function saveChanges() {
            if (!currentEditCell) return;

            const newScore = parseFloat(document.getElementById('scoreInput').value);
            if (isNaN(newScore)) {
                alert('Please enter a valid number');
                return;
            }

            const row = currentEditCell.getRow();
            const rowData = row.getData();
            const username = rowData.username;
            const taskName = currentEditCell.getColumn().getDefinition().title;

            // Update database
            const scores = {};
            scores[taskName] = newScore;
            fetch('/api/database/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username,
                    scores: scores
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentEditCell.setValue(newScore);

                    // Recalculate total score - update total score column
                    let totalScore = 0;
                    for (const key in rowData.scores) {
                        if (rowData.scores[key]) {
                            totalScore += rowData.scores[key];
                        }
                    }
                    row.update({ total_score: totalScore });
                    editModal.hide();
                } else {
                    alert('Failed to update: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error updating entry:', error);
                alert('Failed to update entry');
            });
        }

        function updateTheme() {
            const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';

            const lightTheme = document.getElementById('light-theme');
            const darkTheme = document.getElementById('dark-theme');

            if (isDark) {
                lightTheme.disabled = true;
                darkTheme.disabled = false;
            } else {
                lightTheme.disabled = false;
                darkTheme.disabled = true;
            }

            if (window.tabulatorTable) {
                window.tabulatorTable.redraw(true);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            {% if is_course_admin %}
            editModal = new bootstrap.Modal(document.getElementById('editModal'));

            document.getElementById('editForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveChanges();
            });
            {% endif %}

            // Watch theme changes for database viewer
            updateTheme();
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.attributeName === 'data-bs-theme') {
                        updateTheme();
                    }
                });
            });
            observer.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['data-bs-theme']
            });

            fetch('/api/database')
                .then(response => response.json())
                .then(data => {
                    let columns = [
                        {
                            title: "Username",
                            field: "username",
                            frozen: true,
                            minWidth: 1,
                            width: 120,
                            headerTooltip: "Username"
                        },
                        {
                            title: "Total Score",
                            field: "total_score",
                            frozen: true,
                            sorter: "number",
                            minWidth: 1,
                            headerTooltip: "Total Score"
                        }
                    ];

                    if (window.innerWidth < 500) {
                        columns[1].width = 60;
                    }

                    data.tasks.forEach(task => {
                        columns.push({
                            title: task.name,
                            field: `scores.${task.name}`,
                            sorter: "number",
                            headerTooltip: task.name,
                            {% if is_course_admin %}
                            cellClick: function(e, cell) {
                                editCell(cell);
                            }
                            {% endif %}
                        });
                    });

                    window.tabulatorTable = new Tabulator("#database-table", {
                        data: data.students,
                        columns: columns,
                        layout: "fitDataTable",
                        height: "70vh",
                        pagination: true,
                        paginationSize: 100,
                        paginationSizeSelector: [25, 50, 100, 200, true],
                        initialSort: [{column: "total_score", dir: "desc"}],
                        columnDefaults: {
                            resizable: true,
                            minWidth: 1,
                            maxWidth: 120,
                            formatter: "plaintext",
                            formatterParams: {
                                textLimit: false,
                                htmlChars: true
                            },
                            cssClass: "text-wrap",
                            tooltip: true,
                            tooltipGenerationMode: "hover",
                            tooltipFormatter: function(cell) {
                                const isAdmin = {{ is_course_admin|tojson }};
                                if (!isAdmin && cell.getField() !== "username" && cell.getField() !== "total_score") {
                                    return "Only course admins can edit scores";
                                }
                                return cell.getValue();
                            },
                            vertAlign: "middle"
                        },
                        persistenceMode: "local",
                        persistentLayout: true
                    });

                    // Wait for a short delay to ensure table is rendered
                    setTimeout(() => {
                        const footer = document.querySelector(".tabulator-footer .tabulator-paginator");
                        if (footer) {
                            const exportButton = document.createElement("button");
                            exportButton.id = "export-csv";
                            exportButton.style.marginRight = "10px";
                            exportButton.textContent = "Export as CSV";
                            
                            exportButton.addEventListener("click", function() {
                                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                                const courseName = "{{ course_name }}".replace(/[^a-zA-Z0-9]/g, '_');
                                window.tabulatorTable.download("csv", `${courseName}_database_export_${timestamp}.csv`);
                            });

                            footer.insertBefore(exportButton, footer.firstChild);
                        }
                    }, 100);
                })
                .catch(error => {
                    console.error('Error creating table:', error);
                });
        });
    </script>
{% endblock %} 